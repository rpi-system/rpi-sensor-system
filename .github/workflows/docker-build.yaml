---
    name: Docker Build
    
    on:
      push:
        branches:
          - main
        paths-ignore:
          - 'README.md'

      pull_request:
        paths-ignore:
          - 'README.md'
    
    # cancel any previously-started, yet still active runs of this workflow on the same branch
    concurrency:
      group: ${{ github.ref }}-${{ github.workflow }}
      cancel-in-progress: true
    
    permissions:
      contents: read
      packages: write # needed to push docker image to ghcr.io
      pull-requests: write # needed to create and update comments in PRs
    
    jobs:
      scan:
        name: Scan
        permissions: read-all   
        uses: rpi-system/rpi-workflow-templates/.github/workflows/reusable-trivy-scan-image.yaml@main
          # bretfisher/github-actions-templates/.github/workflows/reusable-trivy-scan-image.yaml@main
        
        secrets:
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
        with:  
          image: 'ghcr.io/bretfisher/github-actions-templates:latest' 
          exit-code: 0
          severity: HIGH,CRITICAL
          ignore-unfixed: true     
          upload-results: false
      
      # run this job on every push to a PR
      # it will push images to GHCR, but not DockerHub
      docker-build-pr:
        name: Call Build on PR
        if: github.event_name == 'pull_request'
        # FIXME: fork this repo and update this path to YOUR reusable workflow location
        uses: rpi-system/rpi-workflow-templates/.github/workflows/reusable-docker-build.yaml@main
        with:  
          # NOTE: there are lots of input options for this reusable workflow
          # read the comments in the inputs area of the reusable workflow for more info
          # https://github.com/BretFisher/docker-build-workflow/blob/main/.github/workflows/reusable-docker-build.yaml
          dockerhub-enable: false
          ghcr-enable: true
          push: true
          image-names: |
            ghcr.io/${{ github.repository }}
    
      # run this job on every push to the default branch (including merges and tags)
      # it will push images to GHCR and DockerHub
      # tags will also include ones like `stable-<date>-<sha>` and `latest`
      docker-build-merge:
        name: Call Build on Push
        # this if is filtered to only the main branch push event (see events at top)
        if: github.event_name == 'push'
        # FIXME: fork this repo and update this path to YOUR reusable workflow location
        uses: rpi-system/rpi-workflow-templates/.github/workflows/reusable-docker-build.yaml@main
        secrets:
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
        with:  
          # NOTE: there are lots of input options for this reusable workflow
          # read the comments in the inputs area of the reusable workflow for more info
          # https://github.com/BretFisher/docker-build-workflow/blob/main/.github/workflows/reusable-docker-build.yaml
          dockerhub-enable: false
          ghcr-enable: true
          push: true
          image-names: |
            ghcr.io/${{ github.repository }}